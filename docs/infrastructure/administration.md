# Infrastructure administration

Treeherder has four apps, and those deployments and their databases are managed by cloudOps:

- [treeherder-prod](https://treeherder.mozilla.org)
- [treeherder-stage](https://treeherder.allizom.org)
- [treeherder-prototype](TBD)
- [treeherder-taskcluster-staging](TBD)

## Common Operations

### Deploying Treeherder

Stage is set to auto-deploy from the `master` branch, and production from the `production` branch. Prototype deploys from a separate `prototype` branch, but it is not kept in sync with `master` (this will require anyone pushing their code to prototype to reset it to lastest `master` when they're done).

Production deploys are a manual process that is performed by a Treeherder admin roughly twice a week by running a task in Jenkins (under Treeherder -> status -> hover over latest master commit in table and click proceed to initiate the promotion).

[What's deployed] will show what commits are currently on stage and production.

[what's deployed]: https://whatsdeployed.io/s/13z/Mozilla/Treeherder

### Reverting deployments

If a production promotion needs to be reverted, cloudOps can do it (ping whomever is listed as main contact in #treeherder-ops slack channel) or a Treeherder admin can do it in the Jenkins console (hover over a previous commit that was deployed to stage and select "rebuild").

### Adding or changing scheduled tasks and environment variables

Changing either of these involves a kubernetes change; you can either open a pull request with the change to the [cloudops-infra repo](https://github.com/mozilla-services/cloudops-infra) if you have access or file a [bugzilla bug](https://bugzilla.mozilla.org/enter_bug.cgi?product=Cloud%20Services&component=Operations%3A%20Releng) and someone from cloudOps will do it for you.

## MySQL instances

These are managed by cloudOps and any deletion of data or access to replica or prototype needs to be arranged through them by filing a [bugzilla bug](https://bugzilla.mozilla.org/enter_bug.cgi?product=Cloud%20Services&component=Operations%3A%20Releng).

### Connecting to MySQL instances

Connections **must** be made using TLS otherwise the connection will fail, but not before
having already leaked the credentials over plain-text.

A tool such as [MySQL Workbench] is recommended, since it's possible to save connection
settings for each RDS instance, speeding up future use and reducing the chance of forgetting
to enable TLS.

When setting up a connection make sure to change the "Use SSL" option to `require` and set
the "SSL CA File" option to point at the AWS public CA certificate, which for convenience can
be used [directly from the Treeherder repository][gcp-cert].

[MySQL workbench]: https://www.MySQL.com/products/workbench/
[gcp-cert]: https://github.com/mozilla/treeherder/blob/master/deployment/gcp/ca-cert.pem

### Granting access to the read-only replica

One of the ways in which we allow users to [access Treeherder data](../accessing_data.md)
is via direct access to our read-only MySQL replica. Mozilla's
ReDash instance use this approach. Only cloudOps can grant access.

Generate the password like this:

```shell
python -c "import string; import secrets; print(secrets.token_hex(30))"
```

```sql
-- Adjust the username and password accordingly.
CREATE USER 'myuser' IDENTIFIED BY 'PASSWORD >=30 CHARACTERS LONG' REQUIRE SSL;

-- Paswords for auth_user are randomly generated by Django and never used/exposed due to SSO.
grant SELECT on treeherder.*
```

Afterwards provide the user with the newly created credentials and the hostname of the
read-only replica (`mysql://<name>:<password>@35.247.25.202/treeherder`), making sure
to emphasise the need to [connect using TLS](#connecting-to-rds-instances).

<!-- prettier-ignore -->
!!! warning
    These credentials will also work on the master production instance, so take care to
    provide the hostname of the replica and not the master - or their queries will run on
    the instance used by Treeherder, affecting its performance.

### Changing MySQL passwords

To change the password for a MySQL account:

1. Set the new password [according to the MySQL documentation].

   For example to change the current user's password:

   ```sql
   SET PASSWORD = 'NEW PASSWORD AT LEAST 30 CHARACTERS LONG';
   ```

   Or to change another user's password:

   ```sql
   SET PASSWORD FOR 'another_user' = 'NEW PASSWORD AT LEAST 30 CHARACTERS LONG';
   ```
