## Frontend stage
FROM node:22-slim AS frontend

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.15.0 --activate

COPY ui/ /app/ui/
COPY package.json rspack.config.js pnpm-lock.yaml .npmrc /app/

RUN pnpm install --frozen-lockfile
RUN pnpm build


## Backend stage
FROM python:3.10.18-slim-bullseye

WORKDIR /app

COPY requirements/ /app/requirements/
RUN apt-get update && apt-get install -q --yes gcc && \
    pip install --no-deps -r requirements/common.txt && \
    apt-get -q --yes remove gcc && \
    apt-get -q --yes autoremove && \
    apt-get clean && \
    rm -rf /root/.cache

COPY bin/ /app/bin/
COPY docker/entrypoint_prod.sh /app/docker/entrypoint_prod.sh
COPY treeherder/ /app/treeherder/
COPY schemas/ /app/schemas/
COPY manage.py newrelic.ini version.json /app/

COPY --from=frontend /app/.build/ /app/.build/

RUN python manage.py collectstatic --noinput

# Generate gzipped versions of files that would benefit from compression, that
# WhiteNoise can then serve in preference to the originals. This is required
# since WhiteNoise's Django storage backend only gzips assets handled by
# collectstatic, and so does not affect files in the `.build/` directory
# since they are instead generated by rspack.
RUN python -m whitenoise.compress .build

RUN groupadd --gid 9500 treeherder && \
    useradd --uid 9500 --gid 9500 --no-create-home --shell /bin/sh treeherder && \
    chown -R treeherder:treeherder /app

USER treeherder

ENTRYPOINT ["/bin/bash", "/app/docker/entrypoint_prod.sh"]
CMD ["web"]
