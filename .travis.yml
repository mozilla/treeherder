# Once mysql 5.6 is available on the container infra, this can be removed.
sudo: required
dist: trusty
python:
  - "2.7"
# This doesn't do anything on the non-container infra. See:
#   https://github.com/travis-ci/travis-ci/issues/4997
# cache:
#   directories:
#     - $HOME/virtualenv/python2.7.9
#     - node_modules
env:
  global:
    - DATABASE_URL='mysql://root@localhost/test_treeherder'
    - DATABASE_URL_RO='mysql://root@localhost/test_treeherder'
    - TREEHERDER_DJANGO_SECRET_KEY='secretkey-1234'
services:
  - rabbitmq
  - memcached
before_install:
  # Manually install mysql 5.6 since the default is v5.5.
  - sudo apt-get update -qq
  - sudo apt-get install -qq mysql-server-5.6 mysql-client-5.6 mysql-client-core-5.6
install:
  - npm install
  # We use `--user` with pip install since the non-container infra doesn't set up
  # a virtualenv, and we cannot use sudo due to:
  #   https://github.com/travis-ci/travis-ci/issues/4989
  # Disabling the pip version check speeds up the install considerably, since peep
  # calls pip once per package, which results in duplicate checks (plus log spam).
  - ./bin/peep.py install --user -r requirements/common.txt -r requirements/dev.txt --disable-pip-version-check
before_script:
  - flake8 --show-source
  - isort --check-only --diff --quiet
  - grunt checkjs
  # Required for Karma tests (http://docs.travis-ci.com/user/gui-and-headless-browsers/)
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - mysql -u root -e 'create database test_treeherder;'
script:
  - npm test
  - py.test tests/$* --runslow
  - ./node_modules/.bin/grunt build --production
notifications:
  email:
    on_success: never
    on_failure: always

# Do not run these on the travis server at this time.
# The end to end tests require the service to be running, but travis can't
# start the service for us.  So we would have to have the default point to
# a dedicated dev service instance that is reach-able by travis.  However, we
# require /etc/hosts to have an entry at this point to reach our current dev
# server.  So these tests should be run only locally for now.
# - karma start config/karma-e2e.conf.js --reporters=dots --browsers=Firefox
